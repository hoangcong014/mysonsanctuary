(function () {
  const translations = {
    'vi-VN': {
      title: "Vá»€ CHÃšNG TÃ”I",
      content: `
        <p><strong>Di sáº£n VÄƒn hÃ³a Tháº¿ giá»›i Khu Ä‘á»n thÃ¡p ChÄƒm Má»¹ SÆ¡n</strong> thuá»™c thÃ´n Má»¹ SÆ¡n, xÃ£ Thu Bá»“n, thÃ nh phá»‘ ÄÃ  Náºµng cÃ³ vá»‹ trÃ­ tá»a Ä‘á»™ Ä‘á»‹a lÃ½:</p>
        <ul>
          <li>VÄ© Ä‘á»™ Báº¯c: 15Â° 46â€² 26.02â€³</li>
          <li>Kinh Ä‘á»™ ÄÃ´ng: 108Â° 6â€² 32.71â€³</li>
          <li>Quy hoáº¡ch báº£o tá»“n vÃ  phÃ¡t huy cÃ³ tá»•ng diá»‡n tÃ­ch: 1.158 ha</li>
          <li>Má»¹ SÆ¡n cÃ¡ch TrÃ  Kiá»‡u (Kinh thÃ nh Simhapura): 20 km</li>
          <li>CÃ¡ch Di sáº£n VÄƒn hÃ³a Tháº¿ giá»›i ÄÃ´ thá»‹ cá»• Há»™i An: 45 km</li>
          <li>CÃ¡ch cá»‘ Ä‘Ã´ Huáº¿ â€“ Di sáº£n VÄƒn hÃ³a Tháº¿ giá»›i: 145 km</li>
          <li>CÃ¡ch thÃ nh phá»‘ ÄÃ  Náºµng: 68 km</li>
        </ul>
        <p>ThÃ¡nh Ä‘á»‹a Má»¹ SÆ¡n tá»a láº¡c trong má»™t thung lÅ©ng kÃ­n cÃ³ Ä‘á»‹a tháº¿ nÃºi non hÃ¹ng vÄ©, thanh nghiÃªm. NÆ¡i Ä‘Ã¢y, vá»›i hÆ¡n 70 cÃ´ng trÃ¬nh kiáº¿n trÃºc Ä‘á»n thÃ¡p cá»§a ná»n vÄƒn minh ChÄƒmpa Ä‘Æ°á»£c káº¿t tinh trong nhá»¯ng di chá»©ng váº­t cháº¥t trÆ°á»ng tá»“n, chá»©a Ä‘á»±ng nhá»¯ng giÃ¡ trá»‹ vá» lá»‹ch sá»­, vÄƒn hÃ³a, kiáº¿n trÃºc, nghá»‡ thuáº­t Ä‘Æ°á»£c táº¡o láº­p trong má»™t thá»i gian dÃ i suá»‘t 9 tháº¿ ká»· (tá»« tháº¿ ká»· IV Ä‘áº¿n tháº¿ ká»· XIII), Ä‘Æ°á»£c Ä‘Ã¡nh giÃ¡ ngang hÃ ng vá»›i cÃ¡c di tÃ­ch ná»•i tiáº¿ng trong khu vá»±c ÄÃ´ng Nam Ã nhÆ° Angkor, Pagan, Borobudur.</p>
        <p>Kazik (Kazimierz â€“ Kwiatkowski) â€“ ngÆ°á»i kiáº¿n trÃºc sÆ° tÃ i ba nhiá»u nÄƒm gáº¯n bÃ³ vá»›i Má»¹ SÆ¡n Ä‘Ã£ nÃ³i: bÃªn cáº¡nh cÃ¡c di tÃ­ch "ngÆ°á»i ChÄƒmpa cá»• Ä‘Ã£ gá»­i tÃ¢m linh vÃ o Ä‘áº¥t Ä‘Ã¡" vÃ  Ä‘Ã£ biáº¿t Ä‘Æ°a thiÃªn nhiÃªn Ä‘á»ƒ lÃ m nÃªn má»™t Má»¹ SÆ¡n trÃ¡ng lá»‡ â€“ thÃ¢m nghiÃªm â€“ hÃ¹ng vÄ©. ÄÃ¢y lÃ  má»™t báº£o tÃ ng kiáº¿n trÃºc Ä‘iÃªu kháº¯c nghá»‡ thuáº­t vÃ´ giÃ¡ cá»§a nhÃ¢n loáº¡i mÃ  sáº½ cÃ²n lÃ¢u chÃºng ta má»›i hiá»ƒu háº¿t.</p>
        <p>Thá»i gian vÃ  chiáº¿n tranh Ä‘Ã£ tÃ n phÃ¡ di tÃ­ch náº·ng ná». NhÆ°ng nhá»¯ng gÃ¬ cÃ²n láº¡i á»Ÿ Má»¹ SÆ¡n váº«n Ä‘Ã³ng má»™t vai trÃ² cá»±c ká»³ quan trá»ng trong di sáº£n lá»‹ch sá»­ vÄƒn hÃ³a kiáº¿n trÃºc nghá»‡ thuáº­t tháº¿ giá»›i.</p>
        <p>TrÆ°á»›c nhá»¯ng giÃ¡ trá»‹ ná»•i báº­t toÃ n cáº§u cá»§a má»™t khu di sáº£n vÄƒn hÃ³a cáº§n pháº£i Ä‘Æ°á»£c báº£o vá»‡ vÃ¬ lá»£i Ã­ch cá»§a cáº£ nhÃ¢n loáº¡i, ngÃ y 4 thÃ¡ng 12 nÄƒm 1999, táº¡i thÃ nh phá»‘ Marrakesh â€“ VÆ°Æ¡ng quá»‘c Ma-rá»‘c, khu di tÃ­ch Má»¹ SÆ¡n Ä‘Æ°á»£c ghi danh vÃ o danh sÃ¡ch di sáº£n vÄƒn hÃ³a tháº¿ giá»›i cá»§a UNESCO.</p>
      `,
      slides: [
        { img: "https://myson3d-preprod.api.dfm-engineering.com/uploads/news/1765179220164-402644371.jpg", title: "KIáº¾N TRÃšC SÆ¯ KAZIMIERZ KWIATKOWSKI CHUYÃŠN GIA BA LAN Vá»šI Má»¸ SÆ N", date: "ğŸ“… 08/12/2025" },
        { img: "https://myson3d-preprod.api.dfm-engineering.com/uploads/news/1765178460710-894489198.jpg", title: "THAÌ‰ CAÌ THÃŠÌ‰ TRÄ‚N VAÌ€ RUÌ€A QUYÌ HIÃŠÌM VÃŠÌ€ MÃ”I TRÆ¯Æ Ì€NG TÆ¯Ì£ NHIÃŠN TAÌ£I RÆ¯Ì€NG MYÌƒ SÆ N", date: "ğŸ“… 08/12/2025" },
        { img: "https://myson3d-preprod.api.dfm-engineering.com/uploads/news/1764752180904-701438629.jpg", title: "Äáº I Há»˜I CÃ”NG ÄOÃ€N CÆ  Sá» BAN QUáº¢N LÃ DI Sáº¢N VÄ‚N HÃ“A THáº¾ GIá»šI Má»¸ SÆ N, NHIá»†M Ká»² 2025â€“2030", date: "ğŸ“… 03/12/2025" }
      ]
    },
    'en': {
      title: "ABOUT US",
      content: `
        <p><strong>My Son Sanctuary World Cultural Heritage</strong> is located in My Son village, Thu Bon commune, Da Nang city with geographic coordinates:</p>
        <ul>
          <li>Latitude North: 15Â° 46â€² 26.02â€³</li>
          <li>Longitude East: 108Â° 6â€² 32.71â€³</li>
          <li>Total conservation and planning area: 1,158 ha</li>
          <li>My Son is 20 km from Tra Kieu (Simhapura Citadel)</li>
          <li>45 km from Hoi An Ancient Town World Cultural Heritage</li>
          <li>145 km from Hue Imperial City â€“ World Cultural Heritage</li>
          <li>68 km from Da Nang city</li>
        </ul>
        <p>My Son Sanctuary is situated in a closed valley with majestic and solemn mountains. Here, more than 70 architectural temple towers of the Champa civilization are crystallized in enduring material evidences, containing historical, cultural, architectural, and artistic values established over a long period of 9 centuries (from the 4th to the 13th century), evaluated on par with famous monuments in Southeast Asia such as Angkor, Pagan, Borobudur.</p>
        <p>Kazik (Kazimierz â€“ Kwiatkowski) â€“ the talented architect who spent many years attached to My Son said: besides the monuments "the ancient Champa people entrusted their spirituality into the earth and stones" and knew how to use nature to create a My Son that is magnificent â€“ solemn â€“ majestic. This is a priceless museum of architectural and sculptural art of humanity that will take us a long time to fully understand.</p>
        <p>Time and war have heavily devastated the monuments. But what remains at My Son still plays an extremely important role in the world's historical, cultural, architectural, and artistic heritage.</p>
        <p>In the face of the outstanding global values of a cultural heritage site that needs to be protected for the benefit of all humanity, on December 4, 1999, in Marrakesh â€“ Kingdom of Morocco, My Son relics were inscribed on the UNESCO World Cultural Heritage list.</p>
      `,
      slides: [
        { img: "https://myson3d-preprod.api.dfm-engineering.com/uploads/news/1765179220164-402644371.jpg", title: "ARCHITECT KAZIMIERZ KWIATKOWSKI, POLISH EXPERT WITH MY SON", date: "ğŸ“… 08/12/2025" },
        { img: "https://myson3d-preprod.api.dfm-engineering.com/uploads/news/1765178460710-894489198.jpg", title: "RELEASING RARE SNAKES AND TURTLES INTO THE NATURAL ENVIRONMENT AT MY SON FOREST", date: "ğŸ“… 08/12/2025" },
        { img: "https://myson3d-preprod.api.dfm-engineering.com/uploads/news/1764752180904-701438629.jpg", title: "GRASSROOTS TRADE UNION CONGRESS OF THE MANAGEMENT BOARD OF THE MY SON WORLD CULTURAL HERITAGE SITE, TERM 2025â€“2030", date: "ğŸ“… 03/12/2025" }
      ]
    }
  };

  let currentLang = 'vi-VN';
  let sliderInterval;
  let newsData = [];

  async function fetchNews() {
    try {
      const response = await fetch('jsons/news.json?v=' + Date.now());
      const json = await response.json();
      if (json.success && json.data) {
        newsData = json.data.map(item => {
          const d = new Date(item.createdAt);
          const dateStr = `ğŸ“… ${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getFullYear()}`;
          return {
            img: item.photo,
            title_vi: item.title,
            title_en: item.title_en,
            content_vi: item.content,
            content_en: item.content_en,
            date: dateStr
          };
        });
      }
    } catch (error) {
      console.error("Error fetching news:", error);
    }
  }

  function getLanguage() {
    if (window.tour && typeof window.tour.getLocale === 'function') {
      const locale = window.tour.getLocale(); // e.g., 'en-US' or 'vi-VN'
      return locale.startsWith('vi') ? 'vi-VN' : 'en';
    }
    return 'vi-VN';
  }

  function createAboutPopup() {
    if (document.getElementById("aboutPopup")) return;

    // Detect language
    currentLang = getLanguage();
    const data = translations[currentLang] || translations['vi-VN'];

    const overlay = document.createElement("div");
    overlay.id = "aboutOverlay";
    overlay.style = `
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 9998;
      backdrop-filter: blur(1px);
    `;
    const container = document.getElementById('viewer') || document.body;
    container.appendChild(overlay);
    document.querySelectorAll("nav, header, footer, .menu, .navbar").forEach(el => el.style.pointerEvents = 'none');

    const popup = document.createElement("div");
    popup.id = "aboutPopup";
    popup.style = `
      display: none;
      position: fixed;
      top: 0%;
      left: 0%;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      color: #ffffff;
      border: 0;
      border-radius: 0px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      z-index: 9999;
      font-family: "Arial", sans-serif;
      overflow: hidden;
    `;

    popup.innerHTML = `
      <style>
        #aboutPopup * { pointer-events: auto; }
        #aboutPopup .close-btn {
          background: none; color: #fff; border: none;
          font-size: 20px; cursor: pointer;
          padding: 5px 10px; border-radius: 12px;
          transition: all 0.2s ease;
        }
        #aboutPopup h2, #aboutPopup h3 {
          margin-top: 0;
          color: #EACB32;
          text-align: center;
        }
        #aboutPopup ul {
          padding-left: 20px;
        }
        #aboutPopup ul li {
          margin-bottom: 8px;
        }
        #aboutPopup p {
          margin-bottom: 12px;
          line-height: 1.6;
        }
        #aboutPopup .close-btn {
          background:rgba(66, 33, 24, 0.32);
          color: #fff;
          border: none;
          font-size: 20px;
          cursor: pointer;
          padding: 5px 10px;
          border-radius: 12px;
          transition: all 0.2s ease;
        }
        #aboutPopup .close-btn:hover {
          background-color: #EACB32;
          color: #fff;
          transform: scale(1.2);
        }
        #aboutPopup .content {
          padding: 20px 80px;
          height: calc(100% - 50px);
          overflow-y: auto;
          overflow-x: hidden;
        }
        .title-divider {
          width: 130px;
          border: none;
          border-bottom: 2px solid #EACB32;
          margin: 10px auto 20px;
        }
        .slider-container {
          margin-top: 60px;
          margin-bottom: 60px;
          position: relative;
          overflow: hidden;
        }
        .slider-track {
          display: flex;
          gap: 20px;
          transition: transform 0.5s ease-in-out;
          will-change: transform;
        }
        .slide-item {
          flex: 0 0 auto;
          background:rgba(234, 203, 50, 0.8);
          color: #422118;
          padding: 10px;
          border-radius: 8px;
          display: flex;
          align-items: center;
          width: 300px;
          gap: 10px;
        }
        .slide-item img {
          width: 100px;
          height: 100px;
          border-radius: 8px;
          object-fit: cover;
        }
        .slide-text {
          flex: 1;
          display: flex;
          flex-direction: column;
          justify-content: center;
          text-align: left;
          overflow: hidden;
        }
        .slide-title {
          font-weight: bold;
          margin-bottom: 5px;
          display: -webkit-box;
          -webkit-line-clamp: 2;
          -webkit-box-orient: vertical;
          overflow: hidden;
        }

        .slide-date {
          font-size: 14px;
          color: #422118;
        }
        .slider-button {
          position: absolute;
          top: 50%;
          transform: translateY(-50%);
          background-color: rgba(255, 255, 255, 0.5);
          border: none;
          font-size: 24px;
          cursor: pointer;
          padding: 5px 10px;
          z-index: 10;
        }
        .slider-button.left { left: 0; }
        .slider-button.right { right: 0; }
      </style>

      <div style="text-align:right; padding:10px;">
        <button onclick="hideAboutPopup()" class="close-btn">âœ–</button>
      </div>

      <div class="content" id="aboutContent">
         <!-- Content injected via JS -->
      </div>
    `;

    const popupContainer = document.getElementById('viewer') || document.body;
    popupContainer.appendChild(popup);
    renderContent();
  }

  function renderContent() {
    const popup = document.getElementById("aboutPopup");
    const container = document.getElementById("aboutContent");
    if (!popup || !container) return;

    const data = translations[currentLang] || translations['vi-VN'];

    // Use newsData if available, otherwise fallback to hardcoded slides
    let slides = data.slides;
    if (newsData.length > 0) {
      slides = newsData.map(item => ({
        img: item.img,
        title: currentLang === 'vi-VN' ? item.title_vi : item.title_en,
        title_vi: item.title_vi,
        title_en: item.title_en,
        content_vi: item.content_vi,
        content_en: item.content_en,
        date: item.date
      }));
    }
    window.currentAboutSlides = slides;

    container.innerHTML = `
        <h2 id="aboutTitle">${data.title}</h2>
        <hr class="title-divider">
        <div id="aboutText">${data.content}</div>

        <div class="slider-container">
          <button class="slider-button left">â®</button>
          <div class="slider-track" id="sliderTrack"></div>
          <button class="slider-button right">â¯</button>
        </div>
    `;

    setTimeout(() => {
      initSlider(slides);
    }, 100);
  }

  function initSlider(slideData) {
    const leftBtn = document.querySelector('.slider-button.left');
    const rightBtn = document.querySelector('.slider-button.right');
    const track = document.getElementById('sliderTrack');
    if (!track) return;

    if (sliderInterval) clearInterval(sliderInterval);

    const loopData = [...slideData, ...slideData, ...slideData];
    const itemWidth = 320;

    // Helper to escape single quotes if needed, though simple replacement is likely safe for titles here
    const buildSlide = ({ img, title, date }, originalIndex) => `
        <div class="slide-item" onclick="if(window.showNewsPopup && window.currentAboutSlides) window.showNewsPopup(window.currentAboutSlides[${originalIndex}])" style="cursor: pointer;">
          <img src="${img}">
          <div class="slide-text">
            <div class="slide-title">${title}</div>
            <div class="slide-date">${date}</div>
          </div>
        </div>
      `;

    track.innerHTML = loopData.map((slide, i) => {
      // Map current loop index to original slideData index
      const originalIndex = i % slideData.length;
      return buildSlide(slide, originalIndex);
    }).join('');
    let index = slideData.length;
    track.style.transition = 'none';
    track.style.transform = `translateX(-${itemWidth * index}px)`;

    function moveSlide(dir) {
      if (track.moving) return;
      track.moving = true;

      index += dir;
      track.style.transition = 'transform 0.5s ease-in-out';
      track.style.transform = `translateX(-${itemWidth * index}px)`;

      track.addEventListener('transitionend', () => {
        if (index <= slideData.length - 1) {
          index += slideData.length;
          track.style.transition = 'none';
          track.style.transform = `translateX(-${itemWidth * index}px)`;
        }
        if (index >= loopData.length - slideData.length) {
          index -= slideData.length;
          track.style.transition = 'none';
          track.style.transform = `translateX(-${itemWidth * index}px)`;
        }
        track.moving = false;
      }, { once: true });
    }

    // Clean up old listeners if any - simplest is to just clone node or re-bind
    // Here we just re-bind as recreateAboutPopup calls initSlider
    const newLeftBtn = leftBtn.cloneNode(true);
    const newRightBtn = rightBtn.cloneNode(true);
    leftBtn.parentNode.replaceChild(newLeftBtn, leftBtn);
    rightBtn.parentNode.replaceChild(newRightBtn, rightBtn);

    newLeftBtn.addEventListener('click', () => moveSlide(-1));
    newRightBtn.addEventListener('click', () => moveSlide(1));

    sliderInterval = setInterval(() => moveSlide(1), 6000);
  }

  window.showAboutPopup = async function () {
    // Update language every time we show, just in case
    currentLang = getLanguage();

    if (newsData.length === 0) {
      await fetchNews();
    }

    // If popup doesn't exist, create it
    if (!document.getElementById("aboutPopup")) {
      createAboutPopup();
    } else {
      // If it exists, simple re-render to update text if language changed
      renderContent();
    }

    const popup = document.getElementById("aboutPopup");
    if (popup) popup.style.display = "block";

    // Re-create overlay if missing (it's removed on hide)
    if (!document.getElementById("aboutOverlay")) {
      const overlay = document.createElement("div");
      overlay.id = "aboutOverlay";
      overlay.style = `
          position: fixed;
          top: 0; left: 0;
          width: 100%; height: 100%;
          background: rgba(0, 0, 0, 0.4);
          z-index: 9998;
          backdrop-filter: blur(1px);
        `;
      const overlayContainer = document.getElementById('viewer') || document.body;
      overlayContainer.appendChild(overlay);
    }
    document.querySelectorAll("nav, header, footer, .menu, .navbar").forEach(el => el.style.pointerEvents = 'none');
  };

  window.hideAboutPopup = function () {
    const popup = document.getElementById("aboutPopup");
    const overlay = document.getElementById("aboutOverlay");
    if (popup) popup.style.display = "none";
    if (overlay) overlay.remove();
    document.querySelectorAll("nav, header, footer, .menu, .navbar").forEach(el => el.style.pointerEvents = 'auto');
    if (sliderInterval) clearInterval(sliderInterval);
  };
})();

